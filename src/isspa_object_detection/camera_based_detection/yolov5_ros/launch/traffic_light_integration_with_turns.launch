<launch>
    <!-- 
    红绿灯检测与决策集成Launch文件（支持转向灯）
    Traffic Light Detection and Decision Integration Launch File (with Turn Support)
    
    该文件启动红绿灯检测和决策模块，支持直行、左转、右转红绿灯的识别和决策
    This file launches traffic light detection and decision modules, supporting 
    straight, left-turn, and right-turn traffic light recognition and decision
    -->
    
    <!-- 参数配置 -->
    <arg name="camera_topic" default="/camera/color/image_raw"/>
    <arg name="model_path" default="$(find yolov5_ros)/scripts/yolov5s_traffic_lights.pt"/>
    <arg name="confidence_threshold" default="0.5"/>
    <arg name="yellow_light_action" default="stop"/>  <!-- 'stop' or 'slow' -->
    <arg name="slow_down_speed" default="0.2"/>
    <arg name="use_turn_support" default="true"/>  <!-- 是否使用转向支持 -->
    <arg name="turn_angle_threshold" default="0.5"/>  <!-- 转向角度阈值（弧度） -->
    <arg name="lookahead_distance" default="5.0"/>  <!-- 前瞻距离（米） -->
    
    <!-- 红绿灯检测节点 -->
    <node name="yolov5_traffic_light_detection" 
          pkg="yolov5_ros" 
          type="detect_ros.py" 
          output="screen">
        <param name="weights" value="$(arg model_path)"/>
        <param name="source" value="$(arg camera_topic)"/>
        <param name="conf_thres" value="$(arg confidence_threshold)"/>
        <param name="view_img" value="false"/>
    </node>
    
    <!-- 红绿灯决策节点 -->
    <group if="$(arg use_turn_support)">
        <!-- 使用支持转向的决策模块 -->
        <node name="traffic_light_decision" 
              pkg="yolov5_ros" 
              type="traffic_light_decision_with_turns.py" 
              output="screen">
            <param name="confidence_threshold" value="$(arg confidence_threshold)"/>
            <param name="yellow_light_action" value="$(arg yellow_light_action)"/>
            <param name="slow_down_speed" value="$(arg slow_down_speed)"/>
            <param name="turn_angle_threshold" value="$(arg turn_angle_threshold)"/>
            <param name="lookahead_distance" value="$(arg lookahead_distance)"/>
        </node>
    </group>
    
    <group unless="$(arg use_turn_support)">
        <!-- 使用简化版决策模块 -->
        <node name="traffic_light_decision" 
              pkg="yolov5_ros" 
              type="traffic_light_decision.py" 
              output="screen">
            <param name="confidence_threshold" value="$(arg confidence_threshold)"/>
            <param name="yellow_light_action" value="$(arg yellow_light_action)"/>
            <param name="slow_down_speed" value="$(arg slow_down_speed)"/>
        </node>
    </group>
    
    <!-- 
    注意：为了正确工作，导航栈需要将速度命令发布到 /cmd_vel_nav 话题
    然后决策模块会将其与红绿灯决策融合后发布到 /cmd_vel 话题
    
    Note: For proper operation, the navigation stack should publish velocity commands 
    to /cmd_vel_nav topic, and the decision module will fuse it with traffic light 
    decisions and publish to /cmd_vel topic
    
    路径话题：决策模块会订阅导航路径来判断转向意图
    Path topic: The decision module will subscribe to navigation path to determine turn intention
    -->
    
</launch>



